# Virgo Admin Panel

Админ-приложение живет в `apps/admin` и построено на Next.js 15 (App Router).

## Скрипты

```powershell
pnpm --filter @virgo/admin dev    # запуск на http://localhost:3001
pnpm --filter @virgo/admin build  # production-сборка
pnpm --filter @virgo/admin lint   # проверка eslint
```

## Аутентификация

- Страница `/login` принимает любую корпоративную почту и пароль. После отправки формы серверный обработчик `app/api/login/route.ts` устанавливает cookie `vs_admin` и перенаправляет в корень.
- Кнопка «Выйти» в топ-баре бьет в `app/api/logout/route.ts`, который удаляет cookie и возвращает пользователя на форму входа.
- Серверный helper `src/lib/auth.ts` считывает cookie и используется в layout’ах для защиты всех маршрутов внутри `(dashboard)`.

## Основные разделы

Каждый раздел использует общий layout с `Sidebar` + `Topbar`, шапку `PageHeader` и таблицы `DataTable`.

| Маршрут      | Назначение                                      |
| ------------ | ----------------------------------------------- |
| `/`          | Дэшборд с ключевыми метриками (MRR, студенты).  |
| `/courses`   | Таблица курсов с куратором, статусом и апдейтами. |
| `/curriculum`| Каталог модулей и переход в Lesson Manager.     |
| `/cohorts`   | Оперативный календарь потоков и заполненности.  |
| `/students`  | Прогресс, платежный статус и активность студентов. |
| `/users`     | Справочник пользователей и ролей с фильтрами.   |
| `/payments`  | Финансовый журнал последних транзакций.         |

## Данные

Все серверные функции в `src/lib/api.ts` берут базовый URL из `@virgo/config`. Если `apiBaseUrl` не задан, используется преднастроенный мок, так что UI работает без запущенного backend’а.

### Lesson Manager

- Страница `/curriculum/[moduleId]` загружает список модулей и уроков через `getModuleDirectory()` и `getModuleLessons()`.
- Левая панель показывает владельца модуля, язык и упорядоченный список уроков; клик переводит форму в режим редактирования.
- Правая панель — форма RU/EN контента, таймингов и видео-метаданных. Сохранение дергает server actions `createLessonAction` / `updateLessonAction`, которые бьют в NestJS эндпоинты `/admin/modules/:moduleId/lessons`.
- Кнопки `↑`, `↓` и `✕` в карточках уроков вызывают `reorderLessonsAction` и `deleteLessonAction`, которые, в свою очередь, обращаются к `/admin/modules/:moduleId/lessons/order` и `DELETE /lessons/:lessonId`. Фронт держит оффлайн-моки, поэтому даже без API можно показать UX.
- При отсутствии backend’а Lesson Manager использует локальные мок-данные, чтобы команда могла демонстрировать UX офлайн.

### Users Directory

- `/users` рендерит `UserDirectoryTable`, который получает данные через `getUserDirectory()` с автоподстановкой моков.
- Эндпоинт `GET /admin/users?limit=` возвращает имя, email, роли, локаль, таймзону и последнюю активность; используется и в UI, и в оффлайн-режиме.
- Таблица поддерживает поиск по имени/email и фильтрацию по роли. Роли показываются статусными pill-бейджами для визуального единства.
- `getAvailableRoles()` дергает `GET /admin/roles` и расширяет список кодов за счёт фактических значений из данных, чтобы UI оставался устойчивым при добавлении новых ролей на backend’е.
- Inline-редактор ролей работает через server action `updateUserRolesAction` → `PUT /admin/users/:id/roles`, валидирует выбор (минимум одна роль), блокирует чекбоксы во время запроса и показывает компактные success/error подсказки.
- NestJS `AdminService` автоматически создает базовые роли (`admin`, `manager`, `support`) при старте приложения, поэтому UI всегда получает набор по умолчанию даже на чистой БД.

## UI-паттерны

- `PageHeader` — повторяемая шапка разделов с подсказкой и действиями.
- `DataTable` + статусные pill-компоненты в CSS — единый стиль таблиц.
- `Topbar` держит поиск и кнопку выхода, а layout следит за авторизацией всех страниц.

Эти блоки задают минимальный UX, на который можно навешивать реальную логику (CRUD, фильтры, экспорт) по мере развития продукта.
